<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Methods Explained</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="/styles/common.css" />
    <style>
      .container-narrow { max-width: 820px; margin: var(--spacing-xl) auto; }
      .card-glass { background: rgba(255,255,255,0.06); border-radius: var(--border-radius-lg); }
      .muted { color: #adb5bd; }
      .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }
      .pointer { cursor: pointer; }
    </style>
  </head>
  <body class="bg-dark text-light">
    <main class="container container-narrow">
      <h1 class="mb-4">Methods Explained</h1>

      <!-- GET -->
      <section class="card card-glass border-0 mb-4">
        <div class="card-body">
          <h2 class="h4">GET</h2>
          <p class="muted">
            GET requests retrieve resources. Your browser uses GET when you type a URL, click a link, or refresh a page.
            GET has no request body and should not change server state.
            Click the button to perform a GET that lists files in the upload directory.
          </p>

          <div class="d-flex gap-2 align-items-center">
            <button id="listBtn" class="btn btn-outline-light">List uploaded files (GET)</button>
            <span id="status" class="muted"></span>
          </div>

          <div id="tableWrap" class="mt-4" hidden>
            <div class="table-responsive">
              <table class="table table-dark table-striped table-hover align-middle mb-0">
                <thead>
                  <tr>
                    <th style="width:50%">Name</th>
                    <th>Link</th>
                    <th class="text-end">Size</th>
                    <th class="text-end">Modified</th>
                  </tr>
                </thead>
                <tbody id="filesTbody"></tbody>
              </table>
            </div>
          </div>

          <div id="errorBox" class="alert alert-danger mt-4 d-none"></div>
        </div>
      </section>

      <!-- (Optional future sections)
      <section class="card card-glass border-0 mb-4">
        <div class="card-body">
          <h2 class="h4">POST</h2>
          <p class="muted">POST sends data in the request body. Common for form submissions and file uploads.</p>
          <!-- reuse your existing upload form here -->
        </div>
      </section>

      <section class="card card-glass border-0">
        <div class="card-body">
          <h2 class="h4">DELETE</h2>
          <p class="muted">DELETE requests remove a resource. Example: DELETE /upload/&lt;filename&gt;.</p>
        </div>
      </section>
      -->
    </main>

    <script>
      // Candidate endpoints to try. Adjust order to match your server.
      const LIST_ENDPOINTS = [
        "/upload/",     // many servers map uploads here
        "/uploads/",
        "/images/uploads/"
      ];

      const statusEl = document.getElementById("status");
      const tableWrap = document.getElementById("tableWrap");
      const tbody = document.getElementById("filesTbody");
      const errorBox = document.getElementById("errorBox");

      document.getElementById("listBtn").addEventListener("click", handleList);

      async function handleList() {
        resetUI();
        statusEl.textContent = "GET …";
        try {
          const { files, base } = await listFilesFromAny();
          if (!files.length) {
            statusEl.textContent = "No files found.";
            tableWrap.hidden = false;
            return;
          }
          renderTable(files, base);
          statusEl.textContent = `OK (${files.length})`;
          tableWrap.hidden = false;
        } catch (e) {
          showError(e.message || String(e));
          statusEl.textContent = "Failed.";
        }
      }

      function resetUI() {
        errorBox.classList.add("d-none");
        errorBox.textContent = "";
        tbody.innerHTML = "";
        tableWrap.hidden = true;
      }

      function showError(msg) {
        errorBox.textContent = msg;
        errorBox.classList.remove("d-none");
      }

      async function listFilesFromAny() {
        let lastErr;
        for (const base of LIST_ENDPOINTS) {
          try {
            const result = await listFiles(base);
            return { files: result, base };
          } catch (e) {
            lastErr = e;
          }
        }
        throw new Error(
          (lastErr && lastErr.message) ||
          "Unable to fetch a directory listing. Ensure autoindex is enabled for one of: " + LIST_ENDPOINTS.join(", ")
        );
      }

      async function listFiles(base) {
        // Force trailing slash for directory GET
        const url = base.endsWith("/") ? base : base + "/";
        const res = await fetch(url, { method: "GET", cache: "no-store" });
        if (!res.ok) {
          throw new Error(`GET ${url} → ${res.status} ${res.statusText}`);
        }

        const ct = (res.headers.get("content-type") || "").toLowerCase();
        if (ct.includes("application/json")) {
          // Prefer JSON if your server provides it
          const json = await res.json();
          // Normalize shapes: ["a.txt","b.png"] or [{name,size,modified}]
          return (json || []).map((it) => {
            if (typeof it === "string") return { name: it, href: url + it };
            return {
              name: it.name || it.filename || "",
              href: it.href || (it.name ? url + it.name : ""),
              size: it.size ?? null,
              modified: it.modified ?? null
            };
          }).filter(row => row.name);
        }

        // Fallback: parse autoindex HTML
        const html = await res.text();
        const doc = new DOMParser().parseFromString(html, "text/html");
        const anchors = Array.from(doc.querySelectorAll("a"));
        // Heuristics: skip parent links and subdirectories
        const files = anchors
          .map(a => a.getAttribute("href") || "")
          .filter(href => href && !href.startsWith("?") && !href.startsWith("#"))
          .filter(href => !href.endsWith("/")) // skip directories
          .map(href => ({
            name: decodeURIComponent(href.replace(/^.*\//, "")),
            href: new URL(href, url).toString()
          }));

        return files;
      }

      function renderTable(files, base) {
        const rows = files.map(f => {
          const size = f.size ?? "";
          const mod  = f.modified ? formatDate(f.modified) : "";
          const link = f.href || (base + f.name);
          return `
            <tr>
              <td class="mono">${escapeHtml(f.name)}</td>
              <td><a class="link-light" href="${encodeURI(link)}" target="_blank" rel="noopener">open</a></td>
              <td class="text-end mono">${size === "" ? "" : humanSize(size)}</td>
              <td class="text-end mono">${escapeHtml(mod)}</td>
            </tr>`;
        }).join("");
        tbody.innerHTML = rows;
      }

      function escapeHtml(s) {
        return String(s)
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;");
      }

      function humanSize(bytes) {
        const n = Number(bytes);
        if (!isFinite(n) || n < 0) return "";
        const units = ["B","KB","MB","GB","TB"];
        let i = 0, v = n;
        while (v >= 1024 && i < units.length - 1) { v /= 1024; i++; }
        return `${v.toFixed(v >= 10 || i === 0 ? 0 : 1)} ${units[i]}`;
        }

      function formatDate(d) {
        try {
          const date = typeof d === "string" ? new Date(d) : new Date(d);
          if (isNaN(date)) return "";
          return date.toISOString().replace("T"," ").slice(0,19) + " UTC";
        } catch { return ""; }
      }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
