<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <title>File List</title>
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css"
            rel="stylesheet" />
        <style>
            .file-item {
                display: flex;
                align-items: center;
                gap: 0.75rem;
                padding: 0.5rem 0.75rem;
                border: 1px solid #343a40;
                border-radius: 0.5rem;
            }
            .file-name {
                flex: 1;
                font-family: ui-monospace, Menlo, Consolas, monospace;
                word-break: break-all;
            }
            .btn-x {
                width: 2rem;
                height: 2rem;
                line-height: 1;
                padding: 0;
                font-weight: 700;
            }
        </style>
    </head>
    <body class="bg-dark text-light">
        <div class="container py-4">
            <div class="mb-3">
                <h1>Upload a file</h1>
                <form
                    action="/upload"
                    method="POST"
                    enctype="multipart/form-data">
                    <label for="formFile" class="form-label"
                        >Default file input example</label
                    >
                    <input
                        class="form-control"
                        type="file"
                        name="file"
                        id="formFile"
                        required />
                    <button type="submit" class="btn btn-outline-light">
                        Upload
                    </button>
                </form>
            </div>

            <h1 class="h3 mb-3">Files</h1>

            <div class="d-flex align-items-center gap-2 mb-3">
                <button id="loadBtn" class="btn btn-outline-light">
                    Load files (GET)
                </button>
                <span id="status" class="text-secondary"></span>
            </div>

            <div id="alert" class="alert alert-danger d-none"></div>

            <ul id="fileList" class="list-unstyled d-grid gap-2"></ul>

            <p id="empty" class="text-secondary mt-3 d-none">No files.</p>
        </div>

        <script>
            const ENDPOINT_LIST = "../cgi-bin/files_json.py";
            const DELETE_BASE = "/upload/"; // DELETE /upload/<filename>

            const loadBtn = document.getElementById("loadBtn");
            const statusEl = document.getElementById("status");
            const alertEl = document.getElementById("alert");
            const listEl = document.getElementById("fileList");
            const emptyEl = document.getElementById("empty");

            loadBtn.addEventListener("click", loadFiles);
            listEl.addEventListener("click", onListClick);

            async function loadFiles() {
                clearUI();
                statusEl.textContent = "GET REQUEST SENT…";
                try {
                    const res = await fetch(ENDPOINT_LIST, {
                        cache: "no-store",
                    });
                    if (!res.ok) throw new Error(`HTTP ${res.status}`);
                    const json = await res.json(); // expects ["a.jpg","b.png", ...]
                    const files = Array.isArray(json)
                        ? json.filter(Boolean)
                        : [];
                    render(files);
                    statusEl.textContent = `GET REQUEST SUCCESS ✅ (${files.length})`;
                } catch (e) {
                    showError(e.message || String(e));
                    statusEl.textContent = "GET REQUEST FAILED ❌";
                }
            }

            function render(files) {
                listEl.innerHTML = files
                    .map(
                        (name) => `
        <li class="file-item" data-name="${escapeAttr(name)}">
          <a class="file-name"  href="${DELETE_BASE + encodeURIComponent(name)}"
         target="_blank" rel="noopener">${escapeHtml(name)}</a>
          <button class="btn btn-outline-danger " title="Delete">delete</button>
        </li>
      `
                    )
                    .join("");
                emptyEl.classList.toggle("d-none", files.length !== 0);
            }

            async function onListClick(e) {
                if (!(e.target instanceof Element)) return;
                if (!e.target.classList.contains("btn-x")) return;

                const li = e.target.closest(".file-item");
                if (!li) return;
                const name = li.getAttribute("data-name");
                if (!name) return;

                if (!confirm(`Delete "${name}"?`)) return;

                try {
                    const res = await fetch(
                        DELETE_BASE + encodeURIComponent(name),
                        { method: "DELETE" }
                    );
                    if (!res.ok)
                        throw new Error(`Delete failed: HTTP ${res.status}`);
                    li.remove();
                    emptyEl.classList.toggle(
                        "d-none",
                        listEl.children.length !== 0
                    );
                    statusEl.textContent = `Deleted: ${name}`;
                } catch (e2) {
                    showError(e2.message || String(e2));
                }
            }

            function clearUI() {
                alertEl.classList.add("d-none");
                alertEl.textContent = "";
                listEl.innerHTML = "";
                emptyEl.classList.add("d-none");
            }
            function showError(msg) {
                alertEl.textContent = msg;
                alertEl.classList.remove("d-none");
            }
            function escapeHtml(s) {
                return String(s)
                    .replace(/&/g, "&amp;")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;")
                    .replace(/"/g, "&quot;");
            }
            function escapeAttr(s) {
                return String(s).replace(/"/g, "&quot;");
            }
        </script>
    </body>
</html>
