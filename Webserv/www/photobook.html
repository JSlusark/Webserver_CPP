<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Evaluator Photobook</title>
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css"
            rel="stylesheet" />
        <style>
            body {
                background-color: #f8f9fa;
            }

            .photo-grid {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
                gap: 1rem;
            }

            .photo-card {
                aspect-ratio: 1 / 1;
                border-radius: 8px;
                overflow: hidden;
                object-fit: cover;
                background-color: #dee2e6;
                display: flex;
                align-items: center;
                justify-content: center;
                cursor: pointer;
                transition: transform 0.2s ease;
            }

            .photo-card:hover {
                transform: scale(1.03);
            }

            .photo-card img {
                width: 100%;
                height: 100%;
                object-fit: cover;
                opacity: 0;
                transition: opacity 0.4s ease;
            }

            .photo-card img.visible {
                opacity: 1;
            }

            .upload-icon {
                font-size: 2.5rem;
                color: #6c757d;
            }

            .toast-container {
                position: fixed;
                bottom: 1rem;
                right: 1rem;
                z-index: 9999;
            }
        </style>
    </head>
    <body>
        <div class="container py-5">
            <h1 class="text-center mb-3">Evaluator Photobook</h1>
            <p class="text-center mb-5 text-muted">
                This page demonstrates real-world applications of
                <strong>GET</strong>, <strong>POST</strong>, and
                <strong>DELETE</strong> through an evaluator photo upload
                system.
            </p>
            <p class="text-center mb-5 text-muted">
                ‚ú® FUN FACT: Press F12 or right-click ‚Üí Inspect to see this
                message. Now that you're here... congrats! You're officially one
                of us üßô‚Äç‚ôÇÔ∏è
            </p>

            <div class="photo-grid mb-4">
                <!-- Upload Button -->
                <div class="photo-card" onclick="showToast()">
                    <span class="upload-icon">+</span>
                </div>
            </div>

            <!-- toast -->
            <form
                action="/upload"
                method="POST"
                enctype="multipart/form-data"
                class="d-none"
                id="uploadForm">
                <input
                    type="file"
                    name="file"
                    id="fileInput"
                    onchange="document.getElementById('uploadForm').submit();" />
            </form>
        </div>

        <!-- Toast -->
        <div class="toast-container">
            <div
                id="uploadToast"
                class="toast align-items-center text-white bg-primary border-0"
                role="alert">
                <div class="d-flex">
                    <div class="toast-body">
                        Please select a photo to upload.
                    </div>
                    <button
                        type="button"
                        class="btn-close btn-close-white me-2 m-auto"
                        data-bs-dismiss="toast"></button>
                </div>
            </div>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"></script>
        <script>
            console.info(`
            Dear evaluator,
            This app demonstrates how HTTP requests work on the frontend using JavaScript.

            üß† The frontend makes a GET request using the fetch() API:
            https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API/Using_Fetch

            ‚úÖ If the request succeeds:
                - the CGI script (cgi-bin/photobook_json.py) returns a JSON file which lists all uploaded images.
                - We use this list to dynamically create <img> elements and insert them into the page (aka "manipulating the DOM").
               üí° Why use JSON when you already have HTML listings?
                    - JSON is the standard for frontend/backend communication.
                    - It's clean, fast, and easy to work with using JavaScript.
                    - Scraping directory listings is fragile and outdated (we're not building tools in 2003 üëµüèª).


            ‚ùå If the request fails or if something is wrong with one of the pictures:
               - A fallback message is shown in the image card.

            ‚è≥ Why a timeout and spinner?
                  - We artificially delay image rendering (~800ms) to simulate real-world async behavior,
                  normalize rendering timing across network conditions, and prevent layout instability (CLS).
                  - It also reflects best practices in frontend architecture: by decoupling render timing
                  from asset arrival, we keep UI predictable even with cache, CDN, or latency variati
            `);

            function showToast() {
                const toast = new bootstrap.Toast(
                    document.getElementById("uploadToast")
                );
                toast.show();

                setTimeout(() => {
                    document.getElementById("fileInput").click();
                }, 400);
            }
            console.time("‚è∞ Completed in");
            fetch("../cgi-bin/photobook_json.py")
                .then((res) => {
                    if (!res.ok) throw new Error("HTTP error " + res.status);
                    return res.json();
                })
                .then((data) => {
                    console.log("‚úÖ Request handled successfully!");
                    console.timeEnd("‚è∞ Completed in");
                    console.log("Retrieved data:", data);

                    const grid = document.querySelector(".photo-grid");

                    data.forEach((filename) => {
                        const card = document.createElement("div");
                        card.className = "photo-card";

                        // Creates the spinner
                        const spinner = document.createElement("div");
                        spinner.className = "spinner-border text-secondary";
                        spinner.setAttribute("role", "status");
                        card.appendChild(spinner);

                        // Creates the image element
                        const img = document.createElement("img");
                        img.src = `/images/uploads/${filename}`;
                        img.alt = filename;
                        img.style.display = "none"; // Hide until loaded
                        const loadDelay = 800; // ms

                        let finished = false;

                        function revealImage(success) {
                            if (finished) return;
                            finished = true;

                            setTimeout(() => {
                                spinner.remove();

                                if (success) {
                                    img.style.display = "block";
                                    img.classList.add("visible");
                                } else {
                                    const errorText =
                                        document.createElement("div");
                                    errorText.textContent = "‚ùå Failed to load";
                                    errorText.style.fontSize = "0.9rem";
                                    errorText.style.color = "#dc3545";
                                    card.appendChild(errorText);
                                }
                            }, loadDelay);
                        }

                        img.onload = () => revealImage(true);
                        img.onerror = () => revealImage(false);
                        card.appendChild(img);
                        grid.appendChild(card);
                    });
                })
                .catch((err) => {
                    console.log("‚ùå Fetch failed!");
                    console.timeEnd("‚è∞ Completed in");
                    console.error("Request returned:", err);
                });
        </script>
    </body>
</html>
